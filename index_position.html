<!DOCTYPE html>
<meta charset="utf-8">
<style type="text/css">

.y  {
	stroke:none;
}
.axis text{
	font-size:9px;
}

/* --- Tooltip --- */

.tooltip-wrapper {
  pointer-events: none;
  text-anchor: middle;
  text-shadow: 0 1px 3px white, 1px 0 3px white, -1px 0 3px white, 0 -1px 3px white;
}


.tooltip-background {
  fill: #ededed;
  opacity: 0.9;
}

}
.tooltip-country {
  font-family: 'TheSerif', sans-serif;
  font-size: 17px;
}

.tooltip-dim {
  font-family: 'TheSerif', sans-serif;
  font-size: 11px;
}

.tooltip-value {
  font-size: 12px;
}


.tooltipTitle {
  position: absolute;
  text-align: center;
  width: auto;
  height: auto;
  padding: 8px;
  margin-top: -20px;
  font: 10px sans-serif;
  /**background: #ddd;**/
  background:#ededed;
  opacity:0.9;
  pointer-events: none;
}

#toolbar{
    display: inline-block;
}
.button{
 min-width: 130px;
  padding: 4px 5px;
  cursor: pointer;
  text-align: center;
  font: 14px  TheSerif, Helvetica, Arial, sans-serif;
  font-weight:400;
  float:left;
  margin: 2px 5px 2px 5px;
  color:#464646;
  border: 1px solid #e0e0e0;
}

.button.active {
  background: #8EA4B1;
  color: #fff;
}

</style>
<div id="toolbar">
<div class="button  " id="radial">Infographic </div>
<div class="button " id="table">Dashboard </div>
<div class="button active" id="comparison">Country position </div>
</div>
<Br/>
<div>Highlight a country: 
<select id="dropDownButton" onchange="highlightCountry(this.value)";>
  <option value="" selected="selected">-</option>
	 <option value="ARG">Argentina</option>
	 <option value="AUS" >Australia</option>
	 <option value="AUT" >Austria</option>
	 <option value="BEL" >Belgium</option>
	 <option value="BRA" >Brazil</option>
	 <option value="CAN" >Canada</option>
	 <option value="CHL" >Chile</option>
	 <option value="CHN" >China</option>
	 <option value="COL" >Colombia</option>
	 <option value="CRI" >Costa Rica</option>
	 <option value="CZE" >Czech Republic</option>
	 <option value="DNK" >Denmark</option>
	 <option value="EST" >Estonia</option>
	 <option value="FIN" >Finland</option>
	 <option value="FRA" >France</option>
	 <option value="DEU" >Germany</option>
	 <option value="GRC" >Greece</option>
	 <option value="HUN" >Hungary</option>
	 <option value="ISL" >Iceland</option>
	 <option value="IND" >India</option>
	 <option value="IDN" >Indonesia</option>
	 <option value="IRL" >Ireland</option>
	 <option value="ISR" >Israel</option>
	 <option value="ITA" >Italy</option>
	 <option value="JPN" >Japan</option>
	 <option value="KOR" >Korea</option>
	 <option value="LVA" >Latvia</option>
	 <option value="LTU" >Lithuania</option>
	 <option value="LUX" >Luxembourg</option>
	 <option value="MEX" >Mexico</option>
	 <option value="NLD" >Netherlands</option>
	 <option value="NZL" >New Zealand</option>
	 <option value= "NOR">Norway</option>
	 <option value="OECD" >OECD</option>
	 <option value="POL" >Poland</option>
	 <option value="PRT" >Portugal</option>
	 <option value="RUS" >Russia</option>
	 <option value="SAU" >Saudi Arabia</option>
	 <option value="SVK" >Slovak Republic</option>
	 <option value="SVN" >Slovenia</option>
	 <option value="ZAF" >South Africa</option>
	 <option value="ESP" >Spain</option>
	 <option value="SWE" >Sweden</option>
	 <option value="CHE" >Switzerland</option>
	 <option value="TUR" >Turkey</option>
	 <option value="GBR" >United Kingdom</option>
	 <option value="USA" >United States</option>
</select>
</div>
</Br>
<div id="viz"></div>
<script src="libs/d3.v4.min.js"></script>
<script>

var margin=40;
var width=document.getElementById("viz").offsetWidth;
var height=400;

var widthChart=width-1*margin,
heightChart=height-1*margin;

var chart=d3.select("#viz")
	.append("svg")
	.attr("width",width)
	.attr("height",height)
 
var format= d3.format(",.2f");

var colorScale = d3.scaleOrdinal()
    .range(["#EDF8F6","#00B7B5","#EF9200","#00B26C"])
    .domain(["","Quantity", "Quality","Inclusiveness"]);

var x = d3.scaleBand()
    .domain(["Employment rate", "Full-Time Equivalent employment rate", "Unemployment rate", "Earnings quality","Labour market insecurity","Job strain","Very long hours of work","Low income rate","Gender income inequality","Employment gap for disadvantaged groups"])
    .rangeRound([margin, widthChart]);


var y = d3.scaleLinear()
	.domain([0,100])
    .rangeRound([heightChart, margin]);

/**var xAxis = d3.svg.axis()
	.scale(x)
	.orient("bottom");

var yAxis= d3.svg.axis()
	.scale(y)
	.orient("left")
	.ticks(5,"%");**/

function createChart(){
	var indChart =chart.append("g")
	.attr("class","chart");


	d3.csv("data/data_key.csv", function(error, data) {
		indChart.append("g")
	      .attr("class", "x axis")
	      .attr("transform", "translate(0," + heightChart + ")")
	      .call(d3.axisBottom(x))
	      .selectAll("text")
	      .call(wrap,x.bandwidth());

  		indChart.append("g")
	    	.attr("class", "y axis")
			.select(".domain").remove()
	    	.attr("transform", "translate("+margin +",0)")
	      	.call(d3.axisLeft(y));


		var datatot=[];
		data.forEach (function(d,i) {
			datatot.push( {
				ISO: d.ISO,
				country : d.Country,
				topic : "Emp",
				topicName : "Employment rate",
				value: d.Emp
			});

			datatot.push( {
				ISO: d.ISO,
				country : d.Country,
				topic : "EmpFTI",
				topicName : "Full-Time Equivalent employment rate",
				value: d.EmpFTI
			});

			datatot.push( {
				ISO: d.ISO,
				country : d.Country,
				topic : "Unemp",
				topicName : "Unemployment rate",
				value: d.Unemp
			});

			datatot.push( {
				ISO: d.ISO,
				country : d.Country,
				topic : "EarnQual",
				topicName : "Earnings quality",
				value: d.EarnQual
			});

			datatot.push( {
				ISO: d.ISO,
				country : d.Country,
				topic : "LabMarkSec",
				topicName : "Labour market insecurity",
				value: d.LabMarkSec
			});

			datatot.push( {
				ISO: d.ISO,
				country : d.Country,
				topic : "JobStrain",
				topicName : "Job strain",
				value: d.JobStrain
			});

			datatot.push( {
				ISO: d.ISO,
				country : d.Country,
				topic : "LongHours",
				topicName : "Very long hours of work",
				value: d.LongHours
			});

			datatot.push( {
				ISO: d.ISO,
				country : d.Country,
				topic : "LowIncome",
				topicName : "Low income rate",
				value: d.LowIncome
			});

			datatot.push( {
				ISO: d.ISO,
				country : d.Country,
				topic : "GenderIneq",
				topicName : "Gender income inequality",
				value: d.GenderIneq
			});

			datatot.push( {
				ISO: d.ISO,
				country : d.Country,
				topic : "EmplGap",
				topicName : "Employment gap for disadvantaged groups",
				value: d.EmplGap
			});

		});

		datatot=datatot
	      	.filter(function(d) { return d.value !="" ; })
	    
	    indChart.selectAll("circle")
		    .data(datatot)
		    .enter()
		    .append("circle")
		    .attr("class", function(d){return d.topic;})
		    .attr("cx",function(d){if(d.value!=="")return margin+ x(d.topicName);})
		    .attr("cy",function(d){if(d.value!=="")return y(d.value)})
			.attr("r", 3.5)
			.style("fill",function(d){
				if(d.country=="OECD")
					return "#0B1E2D"
				else
					return colorScale(pickSector(d.topic));})
			.style("opacity",function(d){
				if(d.country=="OECD")
					return 1
				else
					return 0.2
			});


		///////////////////////////////////////////////////////////////////////////
	    ////////////////////////////// Add Tooltip ////////////////////////////////
	    ///////////////////////////////////////////////////////////////////////////

	   	var tooltipWrapper = indChart.append("g")
	      .attr("class", "tooltip-wrapper")
	      .attr("transform", "translate(" + 0 + "," + 0 + ")")
	      .style("opacity", 0);

	    var tooltipBackground = tooltipWrapper.append("rect")
	      .attr("class", "tooltip-background")
	      .attr("x", 0)
	      .attr("y", 10)
	      .attr("width", 0)
	      .attr("height", 75);
	    
	    var tooltipCountry = tooltipWrapper.append("text")
	      .attr("class", "tooltip-country")
	      .attr("id", "tooltipCountry")
	      .attr("y", 35)
	      .text("");

	    var tooltipDim = tooltipWrapper.append("text")
	        .attr("class", "tooltip-dim")
	        .attr("id", "tooltipDim")
	        .attr("y", 50)
	        .text("");

	  	var tooltipValue = tooltipWrapper.append("text")
	      .attr("class", "tooltip-value")
	      .attr("id", "tooltipValue")
	      .attr("y", 70)
	      .text("");

	    var limit= width - 200; // max height after which part of the tooltip is hidden


	    ///////////////////////////////////////////////////////////////////////////
	    ////////////////////////////// End Tooltip ////////////////////////////////
	    ///////////////////////////////////////////////////////////////////////////

		indChart.selectAll("circle")
		.on("mouseover",function(d){
			d3.select(this)
				.attr("r",8);

			tooltipCountry.text(d.country);
			tooltipDim.text(d.topicName);
			tooltipValue.text (function(){
	            if (d.topic=="EarnQual")
	              return format(d.value) + " USD";
	            else if  (d.topic=="LabMarkSec")
	              return format(d.value) + " ";
	            else
	              return format(d.value) + " %";
        	});

		var maxSize = Math.max(document.getElementById("tooltipDim").getComputedTextLength(), document.getElementById("tooltipValue").getComputedTextLength(),document.getElementById("tooltipCountry").getComputedTextLength());

		tooltipBackground
 			.transition().duration(100)
    		.attr("x", -0.5 * maxSize*1.2)
    		.attr("width", maxSize*1.2)

 		tooltipWrapper
            .transition().duration(200)
            .attr("transform", "translate(" + d3.mouse(this)[0] + "," + d3.mouse(this)[1] + ")")
            .style("opacity", 1);

		})
		.on("mouseout",function(d){

			var sel = document.getElementById('dropDownButton');

				
				d3.select(this)
				.attr("r", function(d){
					if (d.ISO==sel.options[sel.selectedIndex].value)
							return 7
					else
							return 3.5;
				})
	            
	            //Hide the tooltip
	            tooltipWrapper
	                .transition().duration(200)
	                .style("opacity", 0);

		});
        		
	});

}

function wrap(text, width) {
  text.each(function() {
    var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.1, // ems
        y = text.attr("y"),
        dy = parseFloat(text.attr("dy")),
        tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
    while (word = words.pop()) {
      line.push(word);
      tspan.text(line.join(" "));
      if (tspan.node().getComputedTextLength() > width) {
        line.pop();
        tspan.text(line.join(" "));
        line = [word];
        tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
      }
    }
  });
}


function pickSector(topicSelected){
	if(topicSelected=="Emp" ||  topicSelected=="EmpFTI" || topicSelected=="Unemp" )
		return "Quantity";
	else if (topicSelected=="EarnQual" || topicSelected=="LabMarkSec" || topicSelected=="JobStrain" || topicSelected=="LongHours" )
		return "Quality";
	else
		return "Inclusiveness";
};   


function highlightCountry(countryISO){
	chart.selectAll("circle")
	.attr("r",function(d){
		if (d.ISO==countryISO)
				return 7
		else
				return 3.5;
		})
	.style("fill", function(d){
		if (d.ISO==countryISO)
			return "#E73741"
		else if(d.ISO=="OECD")
				return "#0B1E2D"
		else
				return colorScale(pickSector(d.topic));
		})
	.style("opacity", function(d){
		if (d.ISO==countryISO || d.ISO=="OECD")
				return 1
		else
				return 0.25;
		});
}
createChart();

function setupButtons() {
    d3.select('#toolbar')
      .selectAll('.button')
      .on('click', function () {
        // Remove active class from all buttons
        d3.selectAll('.button').classed('active', false);
        // Find the button just clicked
        var button = d3.select(this);

        // Set it as the active button
        button.classed('active', true);

        // Get the id of the button
        var buttonId = button.attr('id');
if (buttonId== "radial")
window.open("index.html", "_self")
else if (buttonId== "table")
window.open("index_dashboard.html", "_self")


else if (buttonId== "comparison")
window.open("index_position.html", "_self")
        // Toggle the bubble chart based on
        // the currently clicked button.
        //draw(buttonId);
      });
  }  
    
  setupButtons();
</script>